---
phase: 05-stats-ranking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/modules/users/user.routes.js
  - backend/src/modules/matches/match.service.js
autonomous: true

must_haves:
  truths:
    - "User can view their match history (past matches with scores, results, dates)"
    - "User can see detailed stats breakdown (wins, losses, rating, win rate)"
    - "Profile endpoint returns comprehensive user data"
  artifacts:
    - path: "backend/src/modules/users/user.routes.js"
      provides: "GET /users/:username/history endpoint for match history"
      exports: ["GET /:username/history"]
    - path: "backend/src/modules/users/user.routes.js"
      provides: "GET /users/:username/stats endpoint for detailed stats"
      exports: ["GET /:username/stats"]
  key_links:
    - from: "backend/src/modules/users/user.routes.js"
      to: "backend/src/modules/matches/match.model.js"
      via: "Match.find({ 'players.playerId': userId })"
      pattern: "players\\.playerId"
---

<objective>
Create Profile API with match history and user stats endpoints.

Purpose: Enable users to view their past matches and detailed statistics
Output: Two new API endpoints for match history and stats
</objective>

<execution_context>
@C:/Users/HP/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/HP/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stats-ranking/05-RESEARCH.md
@backend/src/modules/users/user.routes.js
@backend/src/modules/users/user.model.js
@backend/src/modules/matches/match.model.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add match history endpoint</name>
  <files>backend/src/modules/users/user.routes.js</files>
  <action>
Add GET /:username/history endpoint to user.routes.js:

1. Query Match collection for matches where user is a player
2. Use existing index on players.playerId for efficiency
3. Support pagination: ?page=1&limit=20 (default 20, max 100)
4. Filter by status: default to 'finished' matches only
5. Sort by createdAt descending (newest first)
6. Populate questionId to get title and difficulty
7. Return match details: matchId, question, result (win/loss), score, timestamps

Example response:
{
  success: true,
  data: {
    history: [
      {
        matchId: "...",
        question: { title: "...", difficulty: "easy" },
        result: "win",
        score: 100,
        solvedAt: "2026-02-17T10:00:00Z",
        duration: 120
      }
    ],
    pagination: { page: 1, limit: 20, total: 50, pages: 3 }
  }
}
  </action>
  <verify>
Test endpoint: curl "http://localhost:3000/api/v1/users/testuser/history?page=1&limit=10"
Should return: 200 with paginated match history array
  </verify>
  <done>
GET /api/v1/users/:username/history returns paginated match history with question, result, score, timestamps
</done>
</task>

<task type="auto">
  <name>Task 2: Add user stats endpoint</name>
  <files>backend/src/modules/users/user.routes.js</files>
  <action>
Add GET /:username/stats endpoint to user.routes.js:

1. Get user by username (exclude password/refreshTokens)
2. Calculate additional derived stats:
   - winRate: (wins / matchesPlayed) * 100, formatted as percentage
   - tier: Based on rating (bronze <1100, silver 1100-1299, gold 1300-1599, platinum 1600+)
3. Return comprehensive stats object:
   - wins, losses, matchesPlayed, rating (from model)
   - winRate (calculated)
   - tier (calculated)
   - createdAt (account age)
   - lastActiveAt (if available)

Example response:
{
  success: true,
  data: {
    username: "testuser",
    stats: {
      wins: 10,
      losses: 5,
      matchesPlayed: 15,
      rating: 1250,
      winRate: "66.7%",
      tier: "silver"
    },
    memberSince: "2026-01-15T00:00:00Z"
  }
}
  </action>
  <verify>
Test endpoint: curl "http://localhost:3000/api/v1/users/testuser/stats"
Should return: 200 with user stats including calculated winRate and tier
  </verify>
  <done>
GET /api/v1/users/:username/stats returns detailed user stats with winRate and tier
</done>
</task>

<task type="auto">
  <name>Task 3: Enhance profile endpoint with stats</name>
  <files>backend/src/modules/users/user.routes.js</files>
  <action>
Update existing GET /:username endpoint to include stats in response:

1. Keep existing response for backward compatibility
2. Add stats to user object (wins, losses, matchesPlayed, rating)
3. Add computed fields: winRate, tier
4. Add matchCount (total finished matches)

The existing GET /:username should now return:
{
  success: true,
  data: {
    username: "...",
    avatar: "...",
    role: "user",
    stats: { wins, losses, matchesPlayed, rating, winRate, tier },
    createdAt: "..."
  }
}
  </action>
  <verify>
Test endpoint: curl "http://localhost:3000/api/v1/users/testuser"
Should return: 200 with user data including stats object with winRate and tier
  </verify>
  <done>
GET /api/v1/users/:username returns user profile with computed stats fields
</done>
</task>

</tasks>

<verification>
- Match history endpoint returns paginated results with question details
- Stats endpoint calculates winRate and determines tier correctly
- Profile endpoint enhanced with stats without breaking existing response format
</verification>

<success_criteria>
- GET /users/:username/history works with pagination
- GET /users/:username/stats returns detailed breakdown
- GET /users/:username returns enhanced profile with stats
</success_criteria>

<output>
After completion, create `.planning/phases/05-stats-ranking/05-01-SUMMARY.md`
</output>
