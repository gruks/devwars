---
phase: 05-stats-ranking
plan: 02
type: execute
wave: 2
depends_on: []
files_modified:
  - backend/src/modules/users/user.routes.js
  - backend/src/modules/stats/stats.routes.js
  - backend/src/socket/handlers/game.handler.js
  - backend/src/routes.js
autonomous: true

must_haves:
  truths:
    - "Users can see filtered leaderboard rankings (by time period and skill tier)"
    - "Admins can view global platform statistics dashboard"
    - "Clients receive real-time leaderboard updates after match ends"
  artifacts:
    - path: "backend/src/modules/users/user.routes.js"
      provides: "GET /users/leaderboard with period and tier filters"
      exports: ["GET /leaderboard"]
    - path: "backend/src/modules/stats/stats.routes.js"
      provides: "GET /stats/dashboard for global platform stats"
      exports: ["GET /dashboard"]
    - path: "backend/src/socket/handlers/game.handler.js"
      provides: "LEADERBOARD_UPDATE socket event on match end"
      emits: ["LEADERBOARD_UPDATE"]
  key_links:
    - from: "backend/src/socket/handlers/game.handler.js"
      to: "backend/src/modules/users/user.model.js"
      via: "User.find().sort('stats.rating')"
      pattern: "LEADERBOARD_UPDATE.*emit"
---

<objective>
Implement leaderboard filters, dashboard stats API, and real-time leaderboard updates.

Purpose: Complete the stats system with filtering, global analytics, and live updates
Output: Filtered leaderboard, dashboard endpoint, socket event
</objective>

<execution_context>
@C:/Users/HP/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/HP/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stats-ranking/05-RESEARCH.md
@backend/src/modules/users/user.routes.js
@backend/src/socket/handlers/game.handler.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add leaderboard filters</name>
  <files>backend/src/modules/users/user.routes.js</files>
  <action>
Enhance existing GET /leaderboard endpoint with query parameter filters:

1. Period filter (?period=all|daily|weekly|monthly):
   - all: No time filter (current behavior)
   - daily: Filter to users active today
   - weekly: Filter to users active this week
   - monthly: Filter to users active this month
   - Implementation: Filter by user.updatedAt (last match played)

2. Skill tier filter (?tier=bronze|silver|gold|platinum):
   - bronze: rating < 1100
   - silver: rating 1100-1299
   - gold: rating 1300-1599
   - platinum: rating >= 1600

3. Limit parameter already supported (?limit=10|50|100)

4. Add winRate to each leaderboard entry

Example response:
{
  success: true,
  data: [
    {
      rank: 1,
      username: "player1",
      rating: 1650,
      wins: 20,
      losses: 3,
      winRate: "87.0%"
    }
  ]
}

Maintain backward compatibility: existing calls without filters should work unchanged.
  </action>
  <verify>
Test filters:
- curl "http://localhost:3000/api/v1/users/leaderboard?period=weekly&tier=gold"
- curl "http://localhost:3000/api/v1/users/leaderboard?limit=10"
Should return: 200 with filtered leaderboard
  </verify>
  <done>
GET /api/v1/users/leaderboard supports period and tier query filters
</done>
</task>

<task type="auto">
  <name>Task 2: Add dashboard stats API</name>
  <files>backend/src/modules/stats/stats.routes.js</files>
  <action>
Create new stats module with dashboard endpoint:

1. Create directory: backend/src/modules/stats/
2. Create stats.routes.js with GET /dashboard endpoint

Dashboard should return aggregated platform statistics:
- totalUsers: Count of non-admin users
- totalMatches: Count of finished matches
- activeToday: Users with activity in last 24 hours
- matchesToday: Matches finished today
- averageRating: Average rating across all users
- topPlayers: Top 5 by rating (username, rating, wins, losses)

Use MongoDB aggregation for efficient calculation.

Example response:
{
  success: true,
  data: {
    totalUsers: 150,
    totalMatches: 450,
    activeToday: 25,
    matchesToday: 12,
    averageRating: 1150,
    topPlayers: [
      { username: "pro1", rating: 1800, wins: 50, losses: 5 }
    ]
  }
}

Register route in backend/src/routes.js:
router.use('/stats', require('./modules/stats/stats.routes.js'));
  </action>
  <verify>
Test endpoint: curl "http://localhost:3000/api/v1/stats/dashboard"
Should return: 200 with aggregated platform statistics
  </verify>
  <done>
GET /api/v1/stats/dashboard returns global platform statistics
</done>
</task>

<task type="auto">
  <name>Task 3: Add leaderboard update socket event</name>
  <files>backend/src/socket/handlers/game.handler.js</files>
  <action>
Add LEADERBOARD_UPDATE event emission after match ends:

1. In the match:end socket handler, after updating user stats:
   - Fetch top 50 users by rating
   - Broadcast LEADERBOARD_UPDATE to all connected clients

2. Add to existing match:end handler (around line 290):
```javascript
// Broadcast leaderboard update after match ends
const leaderboard = await User.find({ role: { $ne: 'admin' } })
  .select('username stats.rating stats.wins stats.losses stats.matchesPlayed')
  .sort({ 'stats.rating': -1 })
  .limit(50)
  .lean();

const leaderboardData = leaderboard.map((user, index) => ({
  rank: index + 1,
  username: user.username,
  rating: user.stats?.rating || 1000,
  wins: user.stats?.wins || 0,
  losses: user.stats?.losses || 0,
  winRate: user.stats?.matchesPlayed > 0 
    ? ((user.stats.wins / user.stats.matchesPlayed) * 100).toFixed(1) + '%'
    : '0%'
}));

io.emit('LEADERBOARD_UPDATE', {
  type: 'LEADERBOARD_UPDATE',
  data: leaderboardData
});
```

3. Also emit in timer auto-end block (around line 386) for consistency
  </action>
  <verify>
- Start a match and complete it via socket
- Listen for LEADERBOARD_UPDATE event
- Verify event contains ranked leaderboard array
  </verify>
  <done>
LEADERBOARD_UPDATE socket event emitted after match ends with top 50 rankings
</done>
</task>

</tasks>

<verification>
- Leaderboard filters work correctly (period, tier)
- Dashboard returns accurate aggregated stats
- LEADERBOARD_UPDATE event fires after match completion
</verification>

<success_criteria>
- GET /users/leaderboard supports period and tier filters
- GET /stats/dashboard returns platform-wide statistics
- LEADERBOARD_UPDATE socket event broadcasts to all clients after match end
</success_criteria>

<output>
After completion, create `.planning/phases/05-stats-ranking/05-02-SUMMARY.md`
</output>
