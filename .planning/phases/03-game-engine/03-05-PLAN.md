---
phase: 03-game-engine
plan: '05'
type: execute
wave: 1
depends_on: []
files_modified:
  - code-arena/src/pages/app/Room.tsx
  - code-arena/src/lib/api.ts
  - backend/src/modules/rooms/room.controller.js
  - backend/src/socket/handlers/game.handler.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Room page displays dynamic data from MongoDB (room name, players, status, timer)"
    - "Player can rejoin a room after leaving (room status is still waiting)"
    - "Host can start match and all players receive MATCH_START event"
    - "Code editor shows the debug question with buggy starter code"
    - "Code submission sends to evaluation API and returns pass/fail results"
    - "Match results show winner and update player ratings"
  artifacts:
    - path: "code-arena/src/pages/app/Room.tsx"
      provides: "Dynamic room page with API integration"
      min_lines: 200
    - path: "code-arena/src/lib/api.ts"
      provides: "Room API methods (getRoom, joinRoom, leaveRoom, startMatch, submitCode)"
      exports: ["lobbyApi.getRoom", "lobbyApi.startMatch"]
  key_links:
    - from: "Room.tsx"
      to: "/api/v1/lobby/rooms/:id"
      via: "lobbyApi.getRoom()"
      pattern: "fetch.*room"
    - from: "Room.tsx"
      to: "/api/v1/lobby/rooms/:id/start-match"
      via: "lobbyApi.startMatch()"
      pattern: "startMatch"
---

<objective>
Make the Room page dynamic by connecting it to the backend APIs. Enable players to rejoin rooms after leaving, and make the battle flow work end-to-end with the sandbox execution service.
</objective>

<execution_context>
@C:/Users/HP/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/HP/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-game-engine/03-CONTEXT.md
@.planning/phases/03-game-engine/03-04-SUMMARY.md
@.planning/STATE.md

## Gap Analysis

**Problem**: Room.tsx (code-arena/src/pages/app/Room.tsx) contains static mock data instead of fetching from backend APIs.

**What's done (backend)**:
- Room model with MongoDB storage ✓
- Room API endpoints: create, get, join, leave, start-match ✓
- Match service with submitCode, endMatch ✓
- Execution service calling sandbox-service (compilers) ✓
- Game socket handlers (MATCH_START, CODE_UPDATE, etc.) ✓

**What's missing (frontend)**:
- Room.tsx fetches from API instead of static data
- Rejoin functionality (allow player to rejoin after leaving)
- Battle flow integration (start match, show question, submit code)

**User request**: "write the functionality of /lobby and /room using mongodb and make the data dynamic. Also if someone goes out of the room can comeback too the room and do the battle and also make the room battle work. The features are currently not implementing make them work using the api of Devwars/compilers"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Connect Room.tsx to backend API</name>
  <files>code-arena/src/pages/app/Room.tsx</files>
  <action>
    Replace static mock data in Room.tsx with dynamic API calls:
    1. Use useParams() to get roomId from URL (/app/room/:roomId)
    2. Use useEffect to fetch room data from lobbyApi.getRoom(roomId)
    3. Display dynamic room name, mode, status, timer from API response
    4. Map over room.players to display actual players instead of hardcoded names
    5. Show current user in player list with their status
    6. Display room difficulty and skill level from API
    7. Add loading state while fetching
    8. Add error handling with toast notification

    Reference: code-arena/src/lib/api.ts already has lobbyApi.getRoom() implemented
  </action>
  <verify>
    - Navigate to /app/room/{valid-room-id} shows dynamic room data
    - Room name, players, status reflect MongoDB data
    - 404 or error shown for invalid room ID
  </verify>
  <done>
    Room page displays data from MongoDB instead of static mock. When accessing /app/room/room-id, the page fetches and displays the actual room from the database.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add room rejoin functionality</name>
  <files>code-arena/src/pages/app/Room.tsx, backend/src/modules/rooms/room.controller.js</files>
  <action>
    Enable players to rejoin a room after leaving:

    Backend (room.controller.js):
    1. Modify joinRoom to check if player previously departed but room still waiting
    2. If player has departedAt set and room.status is 'waiting', clear departedAt and re-add to players
    3. Update lastActiveAt to now when rejoining

    Frontend (Room.tsx):
    1. Add "Leave Room" button that calls lobbyApi.leaveRoom(roomId)
    2. After leaving, redirect back to lobby (/app/lobby)
    3. Add "Rejoin" logic: when viewing a room user previously left, show rejoin button
    4. Call lobbyApi.joinRoom(roomId) to rejoin
  </action>
  <verify>
    - Player can leave a waiting room and returns to lobby
    - Player can rejoin the same room if status is still 'waiting'
    - Player cannot rejoin if match already started (status='playing')
  </verify>
  <done>
    Players can leave a room and rejoin if the match hasn't started. The room remembers the player's history and allows rejoin when status is 'waiting'.
  </done>
</task>

<task type="auto">
  <name>Task 3: Connect battle flow - start match and show question</name>
  <files>code-arena/src/pages/app/Room.tsx</files>
  <action>
    Connect the battle flow from room to match:

    1. Add "Start Match" button (visible only to host)
    2. On click, call lobbyApi.startMatch(roomId)
    3. Backend will: select random question, create match, update room status to 'playing'
    4. On success, fetch question details via match or questions API
    5. Display the debug question: title, description, difficulty, starterCode (buggy)
    6. Show timer countdown based on room.timer value
    7. Switch UI from "waiting for players" to "battle view"
    8. Show all players with their code progress
  </action>
  <verify>
    - Host sees "Start Match" button when 2+ players in room
    - Clicking starts match, room status changes to 'playing'
    - Question displays with buggy starter code
    - Timer starts counting down
  </verify>
  <done>
    When host starts match, room transitions to battle state. Question with buggy starter code displays, timer begins, and UI shows battle view.
  </done>
</task>

<task type="auto">
  <name>Task 4: Connect code submission to execution API</name>
  <files>code-arena/src/pages/app/Room.tsx, code-arena/src/lib/api.ts</files>
  <action>
    Enable code submission and evaluation:

    1. Add code editor component (use textarea or Monaco editor if available)
    2. Pre-populate with starterCode from question
    3. Add "Run Tests" button that calls evaluation API
    4. Add "Submit" button that submits code to match

    Frontend API additions (api.ts):
    - Add submitCode(roomId, code) to match API calls

    Flow:
    1. User edits code in editor
    2. "Run Tests" sends code to /api/v1/matches/:id/submit or /api/v1/evaluation/evaluate
    3. Display pass/fail results for each test case
    4. Show score (tests passed / total)
    5. "Submit" finalizes the submission
  </verify>
  <verify>
    - Code editor shows buggy starter code
    - Run Tests evaluates code against test cases
    - Results show which tests passed/failed
    - Score displays (e.g., "3/5 tests passed")
  </verify>
  <done>
    Players can write code, run tests against test cases, and see pass/fail results. The evaluation uses the sandbox-service (compilers) to execute code safely.
  </done>
</task>

<task type="auto">
  <name>Task 5: Handle match end and display results</name>
  <files>code-arena/src/pages/app/Room.tsx</files>
  <action>
    Complete the battle flow with results:

    1. When timer reaches 0 or host ends match:
       - Fetch match results from /api/v1/lobby/rooms/:id/results
    2. Display results screen showing:
       - Winner (highest score, earliest solve time as tiebreaker)
       - All players with their scores
       - Test results breakdown
    3. Update player ratings (+25 winner, -15 loser, min 100)
    4. Show "Play Again" button to create new room
    5. Return to lobby after match ends

    Socket integration (bonus):
    - Listen for MATCH_END socket event to auto-update UI
  </verify>
  <verify>
    - Match end shows winner and all player scores
    - Player ratings update correctly after match
    - Results screen displays with "Return to Lobby" option
  </verify>
  <done>
    When match ends, winner is determined, scores display, player ratings update. Room returns to finished state and players can return to lobby.
  </done>
</task>

</tasks>

<verification>
- [ ] Room page loads dynamic data from MongoDB
- [ ] Player can leave and rejoin waiting room
- [ ] Host can start match with 2+ players
- [ ] Question displays with buggy starter code
- [ ] Code submission evaluates against test cases
- [ ] Match results show winner and update ratings
</verification>

<success_criteria>
Room page fully connected to backend APIs. Players can create/join rooms, start matches, write and submit code, see test results, and see match outcomes with rating updates.
</success_criteria>

<output>
After completion, create `.planning/phases/03-game-engine/03-05-SUMMARY.md`
</output>
