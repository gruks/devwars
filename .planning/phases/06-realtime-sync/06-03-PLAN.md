---
phase: 06-realtime-sync
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/modules/rooms/room.model.js
  - backend/src/modules/rooms/room.controller.js
  - backend/src/modules/socket/handlers/chat.js
autonomous: true

must_haves:
  truths:
    - "Room creation successfully saves all fields to MongoDB"
    - "Room query returns all relevant rooms to clients"
    - "Chat messages persist in MongoDB"
  artifacts:
    - path: "backend/src/modules/rooms/room.model.js"
      provides: "Room schema with all required fields"
    - path: "backend/src/modules/rooms/room.controller.js"
      provides: "HTTP API for room CRUD operations"
    - path: "backend/src/modules/socket/handlers/chat.js"
      provides: "Chat message handling"
  key_links:
    - from: "room.model.js"
      to: "room.controller.js"
      via: "Room.create() + Room.find()"
    - from: "room.model.js"
      to: "lobby.js"
      via: "Room.find() for room list"
---

<objective>
Verify MongoDB room creation is fully functional and add chat message persistence.
</objective>

<execution_context>
@C:/Users/HP/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/HP/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-realtime-sync/06-02-PLAN.md
@.planning/phases/lobby-fix/lobby-fix-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify room creation saves all fields to MongoDB</name>
  <files>backend/src/modules/rooms/room.controller.js</files>
  <action>
    In room.controller.js createRoom function (lines 111-229):
    1. Verify all fields are being saved: name, mode, maxPlayers, isPrivate, difficulty, timer, skillLevel, createdBy, players
    2. Ensure inviteCode is being generated automatically (check schema for default)
    3. Add try-catch with proper error logging for MongoDB errors
    4. Verify the response includes the full room object with _id

    The function should return 201 with the created room object on success.
  </action>
  <verify>
    POST /api/v1/lobby/rooms creates room and returns 201 with room data including _id
  </verify>
  <done>
    Room API creates rooms in MongoDB with all specified fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MongoDB schema for chat messages</name>
  <files>backend/src/modules/rooms/room.model.js</files>
  <action>
    Add chat message schema to room.model.js:
    1. Create messageSchema with: roomId, userId, username, content, type (text/system/action), timestamp
    2. Add messages array to Room schema or create separate Message model
    3. Add indexes for efficient querying by roomId and timestamp

    Add to room.model.js after playerSchema:
    ```javascript
    const messageSchema = new mongoose.Schema({
      roomId: { type: mongoose.Schema.Types.ObjectId, ref: 'Room', required: true },
      userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
      username: { type: String, required: true },
      content: { type: String, required: true, maxlength: 500 },
      type: { type: String, enum: ['text', 'system', 'action'], default: 'text' },
    }, { timestamps: true });

    messageSchema.index({ roomId: 1, createdAt: -1 });
    ```

    Or add to Room schema:
    ```javascript
    messages: [messageSchema]
    ```
  </action>
  <verify>
    Message schema created and indexed in MongoDB
  </verify>
  <done>
    Chat messages can be stored and queried from MongoDB
  </done>
</task>

<task type="auto">
  <name>Task 3: Update chat handler to persist messages to MongoDB</name>
  <files>backend/src/modules/socket/handlers/chat.js</files>
  <action>
    Update chat.js to save messages to MongoDB:
    1. Import the Message model (or Room model with messages array)
    2. When receiving room:chat_message event, save to MongoDB
    3. Keep in-memory cache (last 50) for real-time but also persist
    4. Load message history from MongoDB on room join

    Current in-memory cache should be replaced/augmented with MongoDB storage.
  </action>
  <verify>
    Chat messages appear in MongoDB after being sent
  </verify>
  <done>
    Chat messages persist across server restarts
  </done>
</task>

</tasks>

<verification>
1. Room created via API appears in MongoDB with all fields
2. Room list API returns rooms sorted by createdAt
3. Chat messages saved to MongoDB
4. Message history loads from MongoDB on room join
</verification>

<success_criteria>
- Room creation fully persists to MongoDB with all fields
- Room query API returns all non-finished, non-private rooms
- Chat messages persist to MongoDB and load on room join
</success_criteria>

<output>
After completion, create `.planning/phases/06-realtime-sync/06-03-SUMMARY.md`
</output>
