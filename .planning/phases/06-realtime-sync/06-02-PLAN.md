---
phase: 06-realtime-sync
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - code-arena/src/contexts/SocketContext.tsx
  - code-arena/src/hooks/useRoomSync.ts
autonomous: true

must_haves:
  truths:
    - "Socket reconnects automatically using exponential backoff"
    - "Polling fallback activates when WebSocket fails"
    - "Connection state is displayed in UI"
    - "Room list refreshes when connection is restored"
  artifacts:
    - path: "code-arena/src/contexts/SocketContext.tsx"
      provides: "Socket connection with polling fallback and reconnection"
    - path: "code-arena/src/hooks/useRoomSync.ts"
      provides: "Room data synchronization with polling backup"
  key_links:
    - from: "SocketContext.tsx"
      to: "Lobby.tsx"
      via: "isConnected state + onlineUsers count"
---

<objective>
Implement robust polling fallback and reconnection logic so users stay connected to the lobby even when WebSocket fails.
</objective>

<execution_context>
@C:/Users/HP/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/HP/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-realtime-sync/06-01-PLAN.md
@.planning/phases/02-realtime/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Improve Socket.io transport configuration</name>
  <files>code-arena/src/contexts/SocketContext.tsx</files>
  <action>
    Update the socket.io client configuration in connect() function:
    1. Keep transports: ['websocket', 'polling'] for fallback
    2. Add forceNode: false for better Node.js compatibility
    3. Add reconnection: true with proper attempts and delay
    4. Add pingInterval and pingTimeout for health checks
    5. Add auth endpoint configuration if needed

    The current config (lines 77-83) should be enhanced:
    ```javascript
    const newSocket = io(API_URL, {
      withCredentials: true,
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      pingInterval: 25000,
      pingTimeout: 20000,
    });
    ```
  </action>
  <verify>
    Socket connects using either WebSocket or HTTP polling based on network
  </verify>
  <done>
    Socket works with both WebSocket and HTTP polling transports
  </done>
</task>

<task type="auto">
  <name>Task 2: Add polling fallback for room list</name>
  <files>code-arena/src/hooks/useRoomSync.ts</files>
  <action>
    Enhance useRoomSync.ts to provide HTTP polling fallback:
    1. Add a polling interval that fetches room list every 10 seconds as backup
    2. Only use polling when socket is disconnected
    3. Merge polling data with socket data (socket takes precedence)
    4. Add stopPolling() function to clean up interval

    The hook should:
    - Check if socket is connected
    - If not connected, start polling the REST API: GET /api/v1/lobby/rooms
    - If connected, rely on WebSocket events
    - Switch to polling automatically on disconnect
  </action>
  <verify>
    Room list still updates when WebSocket is disconnected but polling is active
  </verify>
  <done>
    Room list works via polling when WebSocket fails
  </done>
</task>

<task type="auto">
  <name>Task 3: Add connection status indicator to UI</name>
  <files>code-arena/src/pages/app/Lobby.tsx</files>
  <action>
    Update Lobby.tsx to show connection status:
    1. Use socket.isConnected from useSocket() to show status
    2. Display "Connected" / "Reconnecting..." / "Disconnected" in header
    3. Show online user count from socket context

    Current header (lines 254-265) should show:
    - Green dot + "Connected" when isConnected is true
    - Yellow dot + "Reconnecting..." when reconnecting
    - Red dot + "Disconnected" when disconnected
  </action>
  <verify>
    UI shows correct connection status at all times
  </verify>
  <done>
    Users can see their connection status in the lobby
  </done>
</task>

</tasks>

<verification>
1. WebSocket fails -> Polling fallback activates automatically
2. Connection lost -> Reconnection attempts with exponential backoff
3. UI shows connection status in real-time
4. Room list refreshes every 10 seconds when socket is disconnected
</verification>

<success_criteria>
- Socket.io uses WebSocket primary with HTTP polling fallback
- Reconnection works with exponential backoff (up to 10 attempts)
- Polling backup fetches rooms every 10 seconds when WebSocket fails
- UI displays connection status to users
</success_criteria>

<output>
After completion, create `.planning/phases/06-realtime-sync/06-02-SUMMARY.md`
</output>
