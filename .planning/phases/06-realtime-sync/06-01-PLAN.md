---
phase: 06-realtime-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/modules/socket/handlers/room.js
  - backend/src/modules/socket/handlers/lobby.js
  - backend/src/modules/socket/index.js
autonomous: true

must_haves:
  truths:
    - "Room created by one user is visible to all other users in the lobby"
    - "Socket connection uses WebSocket with polling fallback"
    - "Room data persists in MongoDB after creation"
    - "Lobby auto-refreshes when rooms are created/deleted"
  artifacts:
    - path: "backend/src/modules/socket/handlers/room.js"
      provides: "Room creation with proper MongoDB save and lobby broadcast"
    - path: "backend/src/modules/socket/handlers/lobby.js"
      provides: "Lobby room list with proper filtering"
    - path: "code-arena/src/contexts/SocketContext.tsx"
      provides: "Socket connection with WebSocket + polling fallback"
  key_links:
    - from: "room.js (create)"
      to: "lobby.js (broadcast)"
      via: "io.to('lobby').emit('room:created', ...)"
    - from: "SocketContext.tsx"
      to: "lobby.js"
      via: "socket.emit('lobby:join') + socket.on('room:created')"
---

<objective>
Fix room visibility issue - ensure rooms created by one user are visible to all other users in the lobby using proper WebSocket broadcasting and MongoDB persistence.
</objective>

<execution_context>
@C:/Users/HP/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/HP/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/lobby-fix/lobby-fix-04-SUMMARY.md
@.planning/phases/02-realtime/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix room creation broadcast to lobby</name>
  <files>backend/src/modules/socket/handlers/room.js</files>
  <action>
    In room.js, modify the room creation handler to:
    1. After successfully creating room in MongoDB, ensure the room object is properly populated
    2. Use io.to('lobby').emit() with the correct event name 'room:created'
    3. Add debug logging to verify the broadcast is happening
    4. Ensure the room is saved to MongoDB before broadcasting

    The current code (lines 49-68) creates the room but the broadcast may not be reaching other clients. Fix by:
    - Adding socket.join('lobby') before broadcasting to ensure sender also gets the event (optional)
    - Using logger.debug() to trace broadcast events
    - Ensuring the room object sent includes _id, name, status, players, isPrivate
  </action>
  <verify>
    Check backend logs show: "Broadcasting room:created to lobby" when room is created
  </verify>
  <done>
    Room created by user A appears in user B's lobby within 5 seconds
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix lobby join and room list broadcast</name>
  <files>backend/src/modules/socket/handlers/lobby.js</files>
  <action>
    In lobby.js, verify:
    1. The lobby:join handler correctly joins the socket to 'lobby' room (line 23)
    2. The room list query returns all non-finished, non-private rooms
    3. Add debug logging to show how many rooms are being sent to the client

    The query (lines 41-47) should return rooms where:
    - status !== 'finished'
    - isPrivate === false

    Add logging: `logger.debug(\`Sending \${rooms.length} rooms to socket \${socket.id}\`)`
  </verify>
  <verify>
    Check backend logs show correct room count when lobby joins
  </verify>
  <done>
    Lobby receives full room list when joining
  </done>
</task>

<task type="auto">
  <name>Task 3: Add frontend debug logging and verify event listening</name>
  <files>code-arena/src/contexts/SocketContext.tsx, code-arena/src/pages/app/Lobby.tsx</files>
  <action>
    In SocketContext.tsx and Lobby.tsx:
    1. Add console.log statements to verify socket events are being received
    2. In Lobby.tsx, ensure the SOCKET_EVENTS.ROOM.CREATED listener is correctly set up
    3. Verify the frontend event name matches backend: 'room:created'

    In Lobby.tsx lines 136-151, the event listener should update rooms state when room:created is received.
    Add logging: console.log('[Lobby] Room created event received:', data)
  </verify>
  <verify>
    Browser console shows "[Lobby] Room created event received" when another user creates a room
  </verify>
  <done>
    Frontend receives and processes room:created events from WebSocket
  </done>
</task>

</tasks>

<verification>
1. User A creates room -> User B sees it in lobby within 5 seconds
2. User A creates room -> Room appears in MongoDB with correct data
3. Browser console shows no socket errors
</verification>

<success_criteria>
- Room creation broadcasts to all lobby users via WebSocket
- Room data saved to MongoDB with all required fields
- Frontend receives and displays new rooms in real-time
</success_criteria>

<output>
After completion, create `.planning/phases/06-realtime-sync/06-01-SUMMARY.md`
</output>
