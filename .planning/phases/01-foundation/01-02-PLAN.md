---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on:
  - 01-01
files_modified:
  - backend/src/config/db.js
  - backend/src/config/redis.js
  - backend/src/server.js
autonomous: true

must_haves:
  truths:
    - MongoDB connection established on server start
    - Redis connection established on server start
    - Server gracefully handles database disconnections
    - Database connection is reusable across modules
    - Redis client is reusable for sessions and queues
  artifacts:
    - path: "backend/src/config/db.js"
      provides: "MongoDB connection"
      exports: ["connectDB", "disconnectDB"]
      contains: ["mongoose.connect"]
    - path: "backend/src/config/redis.js"
      provides: "Redis connection"
      exports: ["redisClient", "connectRedis"]
      contains: ["redis.createClient"]
    - path: "backend/src/server.js"
      provides: "Updated server with DB connections"
      contains: ["connectDB", "connectRedis"]
  key_links:
    - from: "backend/src/server.js"
      to: "backend/src/config/db.js"
      via: "connectDB() call before listen"
    - from: "backend/src/server.js"
      to: "backend/src/config/redis.js"
      via: "connectRedis() call before listen"
    - from: "backend/src/config/db.js"
      to: "backend/src/config/env.js"
      via: "MONGODB_URI from env"
---

<objective>
Establish MongoDB and Redis connections with proper error handling and graceful shutdown.

Purpose: Database connections are required by all data-persisting modules (auth, users, rooms, matches).
Output: Running server connected to MongoDB and Redis, ready to accept data operations.
</objective>

<execution_context>
@C:/Users/HP/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

Need to choose ORM: Mongoose recommended for MongoDB with Node.js
Need to install: mongoose, redis (ioredis or node-redis)
</context>

<tasks>

<task type="auto">
  <name>Install database dependencies</name>
  <files>
    - backend/package.json
    - backend/package-lock.json
  </files>
  <action>
    Install mongoose for MongoDB ODM
    Install redis (official Redis client for Node.js v4+)
    
    Mongoose chosen because:
    - Schema validation at application level
    - Middleware support for pre/post hooks
    - Built-in methods for CRUD operations
    - Population for references
    - Active community and docs
  </action>
  <verify>Run `npm list mongoose redis` - both packages installed</verify>
  <done>Mongoose and redis packages installed</done>
</task>

<task type="auto">
  <name>Create MongoDB connection module</name>
  <files>
    - backend/src/config/db.js
  </files>
  <action>
    Create database connection module:
    
    - Import mongoose
    - Import logger from utils
    - Import env from env.js
    
    - Create connectDB function:
      - Set mongoose options: useNewUrlParser, useUnifiedTopology
      - Connect to MONGODB_URI from env
      - Log successful connection with host
      - Handle connection errors with clear messages
    
    - Create disconnectDB function:
      - Close mongoose connection
      - Log disconnection
    
    - Handle process signals:
      - SIGTERM: disconnect and exit
      - SIGINT: disconnect and exit
    
    - Export { connectDB, disconnectDB }
  </action>
  <verify>Run `node -e "const { connectDB } = require('./src/config/db.js'); connectDB().then(() => process.exit(0))"` - connects successfully (requires MongoDB running locally)</verify>
  <done>MongoDB connection module created with connect/disconnect functions</done>
</task>

<task type="auto">
  <name>Create Redis connection module</name>
  <files>
    - backend/src/config/redis.js
  </files>
  <action>
    Create Redis connection module:
    
    - Import redis (createClient)
    - Import logger from utils
    - Import env from env.js
    
    - Create redisClient instance:
      - url from REDIS_URL env var
      - Options for reconnection strategy
    
    - Create connectRedis function:
      - Connect to Redis
      - Log successful connection
      - Handle errors
    
    - Set up event handlers:
      - 'connect': log connection
      - 'error': log errors
      - 'reconnecting': log reconnection attempts
    
    - Export { redisClient, connectRedis }
    
    Note: redis v4+ uses async/await for connect()
  </action>
  <verify>Run `node -e "const { connectRedis } = require('./src/config/redis.js'); connectRedis().then(() => process.exit(0))"` - connects successfully (requires Redis running locally)</verify>
  <done>Redis connection module created with client and connect function</done>
</task>

<task type="auto">
  <name>Integrate connections into server startup</name>
  <files>
    - backend/src/server.js
  </files>
  <action>
    Update server.js to integrate database connections:
    
    - Import connectDB from config/db
    - Import connectRedis, redisClient from config/redis
    - Import logger from utils/logger
    
    - Create async startServer function:
      - Try to connect to MongoDB
      - Try to connect to Redis
      - Only start HTTP server after both connections succeed
      - Log "All services connected, starting server..."
      - app.listen on PORT
    
    - Update shutdown handlers:
      - Disconnect MongoDB
      - Disconnect Redis
      - Close HTTP server
      - Exit process
    
    - Call startServer()
    
    - Add error handling for connection failures:
      - Log error with logger.error
      - Exit process with code 1
  </action>
  <verify>Run `npm run dev` with MongoDB and Redis running - server starts and logs show successful connections</verify>
  <done>Server waits for DB connections before starting, graceful shutdown handles disconnections</done>
</task>

</tasks>

<verification>
1. Server starts only after MongoDB and Redis connect
2. Connection logs show successful connections
3. Shutting down server disconnects from both databases
4. Server exits gracefully on SIGTERM/SIGINT
</verification>

<success_criteria>
- MongoDB connection established on startup
- Redis connection established on startup
- Server logs confirm both connections
- Graceful shutdown closes all connections
- Connection failures prevent server start with clear error
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
